{% extends "_base/_base.html" %}

{% macro create_scale(scale_code, scale_descritpion, scale_index) %}
    <div class="core-scale">
        <div class="core-scale-header">
            <div class="core-scale-code">{{ scale_code | replace("_", " ") }}</div>
            <div class="core-scale-label">{{ scale_descritpion }}</div>
        </div>
        <div class="core-scale-data">
            <div>
                {% set straight_items_length = (test_specs["scales"][scale_index][1] | length) %}
                {% set reversed_items_length = (test_specs["scales"][scale_index][2] | length) %}
                {% set scale_length = straight_items_length + reversed_items_length %}
                <span>Risposte date</span>
                <span>{{ scale_length - test_results["missing__" ~ scale_code] }} / {{ scale_length }}</span>
            </div>
            <div>
                <span> Punteggio medio</span>
                <span>{{ test_results["mean__" ~ scale_code] }}</span>
            </div>
        </div>
        {% set standard_scores_obj = test_results["std__mean__" ~ scale_code] %}
        {% if standard_scores_obj %}
        <div class="core-scale-stds">
            {% if test_results.norms_id_length == 1 %}
                <div class="core-scale-std">
                    {{ (standard_scores_obj.values() | list)[0] }}
                </div>
            {% else %}
                {% set norms_results_list = standard_scores_obj | convert_std_dict(test_results.norms_id_length) %}
                {% for n in norms_results_list[::-1] %}
                    <div class="core-scale-std">
                        {% if n.value == n.min %}
                            {% set prop_fill = 2 %}
                        {% elif n.value == n.max %}
                            {% set prop_fill = 98 %}
                        {% else %}
                            {% set prop_fill = ((n.value - n.min)/(n.max - n.min)) * 100 | int %}
                        {% endif %}
                        {% set empty_fill = 100 - prop_fill | int %}
                        <div class="core-scale-std-label">
                                {{ n.norms_id | replace("_", " ") | upper }} - T{{ n.value | int }} 
                                {{ n.interpretation }}
                        </div>
                        <div class="core-scale-std-graph">
                            <div class="core-scale-std-min">{{ n.min | int }}</div>
                            <div class="core-scale-std-bar">
                                <div class="core-scale-std-bar-container">
                                    {% set width_fore = (prop_fill | string)  ~ "%" %}
                                    {% set width_back = (empty_fill | string)  ~ "%" %}
                                    <div class="core-scale-std-bar-fill" style="width: {{ width_fore }};"></div>
                                    <div class="core-scale-std-bar-empty" style="width: {{ width_back }};"></div>
                                </div>
                            </div>
                            <div class="core-scale-std-max">{{ n.max | int }}</div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        {% else %}
            <div><span>n.d.</span></div>
        {% endif %}
    </div>
{% endmacro %}

{% block style %}
    <style>

        .core-flags {
            margin: 24pt 0 6pt 0;
        }

        .core-scales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12pt;
        }

        .core-scales-table td {
            padding: 0;
            width: 50%;
        }

        .core-scales-table td:nth-child(odd) {
            padding-right: .5em;
            padding-bottom: 1em;
        }

        .core-scales-table td:nth-child(even) {
            padding-left: .5em;
            padding-bottom: 1em;
        }
        
        .core-scale {
            background-color: #eee;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid black;
        }

        .core-scale-header {
            margin-bottom: 1rem;
        }

        .core-scale-code {
            font-size: 2em;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .core-scale-label {
            font-style: italic;
            color: #555;
        }

        .core-scale-data > div {
            display: flex;
            gap: .5rem;
        }

        .core-scale-data > div > span:first-child {
            display: inline-block;
            width: 95px;
        }

        .core-scale-stds {
            margin-top: 1rem;
        }
        
        .core-scale-std {
            margin-bottom: 1rem;
        }

        .core-scale-std-label {
            margin-bottom: 6px;
            text-align: left;
        }

        .core-scale-std-graph {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .core-scale-std-min,
        .core-scale-std-max {
            width: 15px;
            font-size: .8rem;
        }

        .core-scale-std-min {
           text-align: left;
        }

        .core-scale-std-max {
            text-align: right;
        }

        .core-scale-std-bar {
            flex-grow: 1;
        }

        .core-scale-std-bar-container {
            display: flex;
            width: 100%;
        }

        .core-scale-std-bar-fill,
        .core-scale-std-bar-empty {
            height: 1em;
        }

        .core-scale-std-bar-fill {
            background-color: #999;
            border-top-left-radius: 1em;
            border-bottom-left-radius: 1em;
        }

        .core-scale-std-bar-empty {
            background-color: #ccc;
            border-top-right-radius: 1em;
            border-bottom-right-radius: 1em;
        }

    </style>
{% endblock %}

{% block body %}
    <div class="page">
        <div>
            <h1 class="report-title">Report CORE</h1>
            <div class="report-bio">
                {{ subject_data(test_results) }}
            </div>
            <div class="core-flags">
                {% set i6 = test_results["i6"] %}
                {% set i9 = test_results["i9"] %}
                {% set i16 = test_results["i16"] %}
                {% set i22 = test_results["i22"] %}
                {% set i24 = test_results["i24"] %}
                {% set i34 = test_results["i34"] %}
                <p>Presenza di risposte anti-convervative &rarr; {% if i9+i16+i24+i34 > 0 %}<span class="text-bold">Sì</span>{% else %}<span class="text-italic">No</span>{% endif %}</p> 
                <p>Presenza di risposte etero-aggressive &rarr; {% if i6+i22 > 0 %}<span class="text-bold">Sì</span>{% else %}<span class="text-italic">No</span>{% endif %}</p> 
            </div>
            <table class="core-scales-table">
                <tr>
                    <td>{{ create_scale("wb", "Disagio psicologico", 0)}}</td>
                    <td>{{ create_scale("pro", "Problemi riferiti",  1)}}</td>
                </tr>
                <tr>
                    <td>{{ create_scale("fun", "Disfunzionalità strumentale e/o relazionale", 2)}}</td>
                    <td>{{ create_scale("risk", "Comportamenti a rischio",  3)}}</td>
                </tr>
                <tr>
                    <td>{{ create_scale("tot_risk", "Disagio generale (senza comportamenti a rischio)", 4)}}</td>
                    <td>{{ create_scale("tot", "Disagio generale", 5)}}</td>
                </tr>
            </table>
        </div>
        {{ page_footer() }}
    </div>
{% endblock %}
